---
- name: Setup Adventist Server
  hosts: adventist_servers
  become: true
  vars_files:
    - vars/main.yml

  roles:
    - role: base_setup
      tags: base
    - role: nginx-badbot-blocker
      tags: nginx

  tasks:

    - name: Copy SSL certificate
      copy:
        src: files/staging.cer
        dest: /etc/ssl/staging.cer
        mode: '0644'

    - name: Copy SSL key
      copy:
        src: files/staging.key
        dest: /etc/ssl/private/staging.key
        mode: '0600'

    - name: Copy nginx configuration
      copy:
        src: files/nginx-default
        dest: /etc/nginx/sites-enabled/default
        mode: '0644'
      notify: restart nginx

    - name: Create user accounts
      user:
        name: "{{ item.name }}"
        state: present
        create_home: yes
        groups: adm,sudo,docker
      with_items:
        "{{ ssh_users }}"

    - name: Configure sudo without password
      copy:
        dest: "/etc/sudoers.d/{{ item.name }}"
        content: "{{ item.name }} ALL=(ALL) NOPASSWD:ALL"
        mode: '0440'
        validate: /usr/sbin/visudo -cf %s
      with_items:
        "{{ ssh_users }}"

    - name: set up github keys
      authorized_key:
        user: "{{ item.name }}"
        state: present
        key: "{{ lookup('url', 'https://github.com/' ~ item.github ~ '.keys', split_lines=False) }}"
        manage_dir: yes
      loop: "{{ ssh_users }}"
      loop_control:
        label: "{{ item.name }} ‚Üê {{ item.github }}"
      tags: github_keys

    - name: Configure Docker login
      docker_login:
        registry_url: ghcr.io
        username: orangewolf
        password: "{{ ghcr_token }}"

    - name: Copy deploy key
      copy:
        src: files/id_rsa
        dest: /root/.ssh/id_rsa
        mode: '0600'
        owner: root
        group: root

  handlers:
    - name: restart nginx
      service:
        name: nginx
        state: restarted
